<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Battle Robot - Pro Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
        body { margin: 0; background: #348C31; overflow: hidden; touch-action: none; font-family: 'Arial', sans-serif; }
        
        /* Botão Sair (Restaurado) */
        #btn-quit { 
            position: fixed; top: 20px; left: 20px; 
            padding: 10px 25px; background: #e74c3c; color: white; 
            font-weight: bold; border: 2px solid #c0392b; border-radius: 8px; 
            cursor: pointer; z-index: 200; 
        }

        /* Interface de Usuário (Vivos e Mira) */
        #ui { 
            position: fixed; top: 20px; right: 20px; 
            color: white; text-align: right; z-index: 100; 
            text-shadow: 2px 2px 4px #000; pointer-events: none;
        }
        .stat { font-size: 24px; font-weight: bold; }

        /* Contagem Regressiva Inicial */
        #countdown {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #fff; font-size: 120px; font-weight: 900;
            text-shadow: 5px 5px 0 #000; z-index: 1000; pointer-events: none;
        }

        /* Joystick Visual */
        #joy-bg { 
            position: fixed; bottom: 50px; left: 50px; 
            width: 120px; height: 120px; background: rgba(255,255,255,0.1); 
            border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; 
            z-index: 60; pointer-events: none; 
        }
        #joy-stick { 
            position: absolute; top: 40px; left: 40px; 
            width: 40px; height: 40px; background: #fff; border-radius: 50%; 
        }

        /* Botão de Tiro */
        #btn-shoot { 
            position: fixed; bottom: 60px; right: 60px; 
            width: 100px; height: 100px; background: rgba(231, 76, 60, 0.7); 
            border: 4px solid white; border-radius: 50%; 
            z-index: 60; color: white; font-weight: bold; 
            display: flex; align-items: center; justify-content: center;
            user-select: none; pointer-events: none;
        }

        /* Tela de Fim de Jogo (Sem botões, apenas aviso) */
        #overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); display: none; 
            flex-direction: column; align-items: center; justify-content: center; 
            z-index: 2000; color: white;
        }
    </style>
</head>
<body>

    <button id="btn-quit" onclick="window.location.href='index.html'">SAIR</button>

    <div id="ui">
        <div class="stat">VIVOS: <span id="count">31</span></div>
        <div style="font-size: 14px;">MIRA: <span id="tg">LIVRE</span></div>
    </div>

    <div id="countdown">3</div>
    
    <div id="joy-bg"><div id="joy-stick"></div></div>
    <div id="btn-shoot">FOGO</div>

    <div id="overlay">
        <h2 id="msg-fim" style="font-size: 48px;">FIM DE JOGO</h2>
        <p style="font-size: 18px;">Reiniciando partida automaticamente...</p>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const config = { 
            type: Phaser.AUTO, 
            width: window.innerWidth, height: window.innerHeight, 
            physics: { default: 'arcade' },
            input: { activePointers: 3 },
            scene: { preload: pre, create: cre, update: upd } 
        };

        let player, bots, tiros, objetos, gameAtivo = false, gameFim = false;
        let joyActive = false, moveVec = {x:0, y:0}, joyPointer = null;
        let zonaRaio = 2800, zonaG;
        let contagem = 3;

        new Phaser.Game(config);

        function pre() {
            this.load.image('casa', 'https://labs.phaser.io/assets/sprites/house.png'); 
            this.load.image('arvore', 'https://labs.phaser.io/assets/sprites/tree-oak.png');
        }

        function cre() {
            this.cameras.main.setBackgroundColor('#348C31');
            this.physics.world.setBounds(0, 0, 4000, 4000);
            zonaG = this.add.graphics();

            const pColor = parseInt((localStorage.getItem('playerColor')||'#3498db').replace('#','0x'), 16);
            const g = this.make.graphics();
            g.fillStyle(pColor).fillRect(0,0,40,40).fillStyle(0x000).fillRect(35,12,25,16).generateTexture('pTex', 65,40);
            g.clear().fillStyle(0x111).fillRect(0,0,40,40).fillStyle(0xff0000).fillRect(35,12,25,16).generateTexture('bTex', 65,40);
            g.clear().fillStyle(0xffff00).fillCircle(5,5,5).generateTexture('bt', 10,10);

            objetos = this.physics.add.staticGroup();
            for(let i=0; i<75; i++) {
                let x = Phaser.Math.Between(150, 3850);
                let y = Phaser.Math.Between(150, 3850);
                objetos.create(x, y, Math.random() > 0.5 ? 'casa' : 'arvore').setScale(1.2).refreshBody();
            }

            let startX = parseFloat(params.get('x')) || 2000;
            let startY = parseFloat(params.get('y')) || 2000;
            
            tiros = this.physics.add.group();
            player = this.physics.add.sprite(startX, startY, 'pTex').setOrigin(0.5).setCollideWorldBounds(true);
            bots = this.physics.add.group();

            for(let i=0; i<30; i++) {
                let bx, by;
                do { bx = Phaser.Math.Between(200, 3800); by = Phaser.Math.Between(200, 3800); } 
                while (Phaser.Math.Distance.Between(bx, by, startX, startY) < 900);
                bots.create(bx, by, 'bTex').setOrigin(0.5).setCollideWorldBounds(true).setBounce(1);
            }

            this.physics.add.collider([player, bots], objetos);
            this.physics.add.collider(bots, bots);
            this.physics.add.overlap(tiros, bots, (t, b) => { if(t.owner !== b) { t.destroy(); b.destroy(); atualizarContagem(); } });
            this.physics.add.overlap(tiros, player, (p, t) => { if(t.owner !== p && !gameFim) finalizarJogo("DERROTA!"); });
            this.physics.add.collider(tiros, objetos, t => t.destroy());

            this.cameras.main.startFollow(player, true, 0.1, 0.1);

            let cdDiv = document.getElementById('countdown');
            let timer = setInterval(() => {
                contagem--;
                if(contagem > 0) cdDiv.innerText = contagem;
                else { cdDiv.innerText = "VAI!"; gameAtivo = true; clearInterval(timer); setTimeout(() => cdDiv.innerText = "", 1000); }
            }, 1000);

            this.input.on('pointerdown', (pointer) => {
                if (pointer.x < window.innerWidth / 2) { joyActive = true; joyPointer = pointer; } 
                else { atirar(this, player); }
            });

            this.input.on('pointerup', (pointer) => {
                if (pointer === joyPointer) {
                    joyActive = false; joyPointer = null; moveVec = {x:0, y:0};
                    document.getElementById('joy-stick').style.transform = 'translate(0px,0px)';
                }
            });
        }

        function atualizarContagem() {
            let total = bots.countActive() + 1;
            document.getElementById('count').innerText = total;
            if (total === 1 && !gameFim) finalizarJogo("VITÓRIA!");
        }

        function atirar(cena, atirador) {
            if (!gameAtivo || gameFim) return;
            let agora = cena.time.now;
            if (agora < (atirador.lastShot || 0) + 500) return;
            atirador.lastShot = agora;
            let b = tiros.create(atirador.x, atirador.y, 'bt');
            b.owner = atirador;
            cena.physics.velocityFromRotation(atirador.rotation, 1300, b.body.velocity);
        }

        function finalizarJogo(msg) {
            if(gameFim) return;
            gameFim = true;
            document.getElementById('msg-fim').innerText = msg;
            document.getElementById('overlay').style.display = 'flex';
            setTimeout(() => { location.reload(); }, 2000);
        }

        function upd() {
            if (!gameAtivo || gameFim) { player.setVelocity(0); return; }

            if (joyActive && joyPointer) {
                const centerX = 110, centerY = window.innerHeight - 110;
                let dx = joyPointer.x - centerX, dy = joyPointer.y - centerY;
                let dist = Math.sqrt(dx*dx + dy*dy), angle = Math.atan2(dy, dx), moveDist = Math.min(dist, 40);
                moveVec = { x: Math.cos(angle) * (moveDist/40), y: Math.sin(angle) * (moveDist/40) };
                document.getElementById('joy-stick').style.transform = `translate(${Math.cos(angle)*moveDist}px, ${Math.sin(angle)*moveDist}px)`;
            }

            let vx = 0, vy = 0;
            let cursors = this.input.keyboard.addKeys('W,A,S,D');
            if(cursors.A.isDown) vx = -450; else if(cursors.D.isDown) vx = 450;
            if(cursors.W.isDown) vy = -450; else if(cursors.S.isDown) vy = 450;
            if(joyActive) { vx = moveVec.x * 450; vy = moveVec.y * 450; }
            player.setVelocity(vx, vy);

            zonaRaio -= 0.65;
            zonaG.clear().lineStyle(10, 0xff0000).strokeCircle(2000, 2000, zonaRaio);
            if (Phaser.Math.Distance.Between(player.x, player.y, 2000, 2000) > zonaRaio) finalizarJogo("MORREU NA ZONA!");

            let alvo = null, minDist = 750;
            bots.children.iterate(b => {
                if(b && b.active) {
                    if (Phaser.Math.Distance.Between(b.x, b.y, 2000, 2000) > zonaRaio) { b.destroy(); atualizarContagem(); }
                    let d = Phaser.Math.Distance.Between(player.x, player.y, b.x, b.y);
                    if(d < minDist) { minDist = d; alvo = b; }
                }
            });

            if (alvo) {
                player.rotation = Phaser.Math.Angle.Between(player.x, player.y, alvo.x, alvo.y);
                document.getElementById('tg').innerText = "TRAVADA";
            } else if (Math.abs(vx) > 0 || Math.abs(vy) > 0) {
                player.rotation = Math.atan2(vy, vx);
                document.getElementById('tg').innerText = "LIVRE";
            }

            bots.children.iterate(b => {
                if(b && b.active) {
                    let d = Phaser.Math.Distance.Between(b.x, b.y, player.x, player.y);
                    if(d < 650) {
                        b.rotation = Phaser.Math.Angle.Between(b.x, b.y, player.x, player.y);
                        this.physics.velocityFromRotation(b.rotation, 220, b.body.velocity);
                        atirar(this, b);
                    }
                }
            });
        }
    </script>
</body>
</html>
